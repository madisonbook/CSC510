name: Run Tests

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build test services
      run: |
        docker compose -f proj2/docker-compose.yml --profile test build
    
    - name: Run Meal Tests
      run: |
        docker compose -f proj2/docker-compose.yml --profile test up test-meals --abort-on-container-exit --exit-code-from test-meals

    - name: Run User Tests
      run: |
        docker compose -f proj2/docker-compose.yml --profile test up test-users --abort-on-container-exit --exit-code-from test-users

    - name: Run All Tests with Coverage
      run: |
        docker compose -f proj2/docker-compose.yml --profile test up test-all --abort-on-container-exit --exit-code-from test-all

    - name: Extract coverage reports
      if: always()
      run: |
        # Copy coverage reports from container
        docker cp test_all:/app/htmlcov ./htmlcov || true
        docker cp test_all:/app/coverage.xml ./coverage.xml || true
    
    - name: Upload coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: Upload coverage HTML report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30
    
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read coverage report
          let coverageComment = '## ðŸ“Š Test Coverage Report\n\n';
          
          try {
            if (fs.existsSync('coverage.xml')) {
              const xml = fs.readFileSync('coverage.xml', 'utf8');
              
              // Extract coverage percentage
              const match = xml.match(/line-rate="([0-9.]+)"/);
              if (match) {
                const coverage = (parseFloat(match[1]) * 100).toFixed(1);
                coverageComment += `**Coverage:** ${coverage}%\n\n`;
                
                // Add status based on thresholds
                if (coverage >= 80) {
                  coverageComment += 'âœ… **Status:** Excellent coverage (â‰¥80%)\n';
                } else if (coverage >= 70) {
                  coverageComment += 'âš ï¸ **Status:** Good coverage (â‰¥70%), aim for 80%\n';
                } else {
                  coverageComment += 'âŒ **Status:** Coverage below 70%, needs improvement\n';
                }
              } else {
                coverageComment += 'âš ï¸ Could not parse coverage percentage\n';
              }
            } else {
              coverageComment += 'âš ï¸ Coverage report not found\n';
            }
          } catch (error) {
            coverageComment += `âš ï¸ Error reading coverage: ${error.message}\n`;
          }
          
          coverageComment += '\nðŸ“ Download detailed HTML report from the artifacts section above.\n';
          
          // Post comment
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageComment
            });
          } catch (error) {
            console.log('Could not post comment:', error);
          }
    
    - name: Add coverage to summary
      if: always()
      run: |
        echo "## ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f coverage.xml ]; then
          # Extract coverage using Python (more reliable)
          COVERAGE=$(python3 -c "
          import xml.etree.ElementTree as ET
          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              coverage = float(root.attrib.get('line-rate', 0)) * 100
              print(f'{coverage:.1f}')
          except Exception as e:
              print('N/A')
          " 2>/dev/null || echo "N/A")
          
          echo "**Overall Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add status emoji
          if [ "$COVERAGE" != "N/A" ]; then
            COVERAGE_NUM=$(echo $COVERAGE | cut -d'%' -f1)
            if (( $(echo "$COVERAGE_NUM >= 80" | bc -l) )); then
              echo "âœ… Excellent coverage!" >> $GITHUB_STEP_SUMMARY
            elif (( $(echo "$COVERAGE_NUM >= 70" | bc -l) )); then
              echo "âš ï¸ Good coverage, aim for 80%" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Coverage needs improvement" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        else
          echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Download detailed report from artifacts" >> $GITHUB_STEP_SUMMARY
    
    - name: Cleanup
      if: always()
      run: |
        docker compose -f proj2/docker-compose.yml --profile test down -v
        docker system prune -f

  test-summary:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some tests failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
        fi
